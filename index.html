/* =====================================================
   TRABAJO A SALARIO MINIMO
   SINGLE SCRIPT — BUILD DEFINITIVO
   Creado por Aidan

   AVISO:
   Esta obra NO sigue la cronología oficial de FNaF.
   Es una interpretación independiente.
   ===================================================== */

(function(){
'use strict';

// =====================================================
// NAMESPACE GLOBAL
// =====================================================
const TSM = {};
window.TSM = TSM;

// =====================================================
// CONFIGURACION GENERAL
// =====================================================
TSM.config = {
  startHour: 0,
  endHour: 6,
  tickRate: 1000,          // 1 minuto de juego por segundo
  powerDrainBase: 0.25,
  powerDrainDoors: 0.15,
  glitchChance: 0.07,
  messageFade: 1200
};

// =====================================================
// ESTADO GLOBAL
// =====================================================
TSM.state = {
  hour: 0,
  minute: 0,
  power: 100,
  alive: true,
  initialized: false,
  doors: { left:false, right:false },
  animatronics: {
    rabbit: { room: 0, active: true },
    bear:   { room: 0, active: false }
  }
};

// =====================================================
// SISTEMA DE EVENTOS
// =====================================================
TSM.events = {
  listeners: {},
  on(evt, cb){ (this.listeners[evt] ??= []).push(cb); },
  emit(evt, data){ (this.listeners[evt]||[]).forEach(f=>f(data)); }
};

// =====================================================
// UTILIDADES
// =====================================================
TSM.utils = {
  clamp(v,min,max){ return Math.min(Math.max(v,min),max); },
  time(){ return `${TSM.state.hour}:${String(TSM.state.minute).padStart(2,'0')}`; },
  rand(a,b){ return Math.random()*(b-a)+a; }
};

// =====================================================
// LOG Y MENSAJES
// =====================================================
TSM.ui = {
  log(type,msg){ console.log(`[${TSM.utils.time()}] ${type}: ${msg}`); },
  message(text){
    const el = document.createElement('div');
    el.textContent = text;
    el.style.cssText = `
      position:fixed;bottom:15%;left:50%;transform:translateX(-50%);
      color:#8b0000;font-family:monospace;letter-spacing:3px;
      opacity:0;transition:opacity 1s;z-index:9999;`;
    document.body.appendChild(el);
    requestAnimationFrame(()=> el.style.opacity=1);
    setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(),TSM.config.messageFade); },3000);
  }
};

// =====================================================
// LOOP PRINCIPAL
// =====================================================
TSM.loop = {
  id:null,
  start(){ if(this.id) return; this.id=setInterval(()=>TSM.events.emit('tick'),TSM.config.tickRate); },
  stop(){ clearInterval(this.id); this.id=null; }
};

// =====================================================
// TIEMPO
// =====================================================
TSM.events.on('tick',()=>{
  if(!TSM.state.alive) return;

  TSM.state.minute++;
  if(TSM.state.minute>=60){
    TSM.state.minute=0;
    TSM.state.hour++;
    TSM.ui.log('HORA',TSM.utils.time());
  }

  if(TSM.state.hour>=TSM.config.endHour){
    TSM.control.finishShift();
  }
});

// =====================================================
// ENERGIA
// =====================================================
setInterval(()=>{
  if(!TSM.state.alive) return;

  let drain = TSM.config.powerDrainBase;
  if(TSM.state.doors.left) drain += TSM.config.powerDrainDoors;
  if(TSM.state.doors.right) drain += TSM.config.powerDrainDoors;

  TSM.state.power = TSM.utils.clamp(TSM.state.power - drain, 0, 100);

  if(TSM.state.power<=0){
    TSM.control.kill('SIN ENERGIA');
  }
},1500);

// =====================================================
// IA SIMPLIFICADA
// =====================================================
setInterval(()=>{
  if(!TSM.state.alive) return;

  const rabbit = TSM.state.animatronics.rabbit;
  if(rabbit.active && Math.random()<0.3){ rabbit.room++; }

  if(rabbit.room>3 && !TSM.state.doors.left){
    TSM.control.kill('EL CONEJO ENTRO');
  }
},4000);

// =====================================================
// EVENTOS NARRATIVOS
// =====================================================
TSM.events.on('tick',()=>{
  const h = TSM.state.hour;
  if(h===1 && TSM.state.minute===10) TSM.ui.message('Movimiento detectado');
  if(h===3 && TSM.state.minute===0)  TSM.ui.message('No debiste aceptar este trabajo');
  if(h===5 && TSM.state.minute===30) TSM.ui.message('Ya es demasiado tarde para renunciar');
});

// =====================================================
// GLITCH VISUAL
// =====================================================
setInterval(()=>{
  if(Math.random()<TSM.config.glitchChance){
    document.body.style.filter='contrast(200%) brightness(50%)';
    setTimeout(()=>document.body.style.filter='',120);
  }
},2000);

// =====================================================
// CONTROL DE ESTADO
// =====================================================
TSM.control = {
  kill(reason){
    if(!TSM.state.alive) return;
    TSM.state.alive=false;
    TSM.loop.stop();
    TSM.ui.message(`MUERTO: ${reason}`);
    TSM.ui.log('FIN',reason);
  },
  finishShift(){
    TSM.state.alive=false;
    TSM.loop.stop();
    TSM.ui.message('6:00 A.M. — SALIDA AUTORIZADA');
  }
};

// =====================================================
// INICIO
// =====================================================
document.addEventListener('DOMContentLoaded',()=>{
  if(TSM.state.initialized) return;
  TSM.state.initialized=true;
  TSM.ui.log('INICIO','Fredbear’s Family Diner — Halloween 2026');
  TSM.loop.start();
});

})();
